<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SMOKE HUB">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="images/IMG_3689.jpeg"> 
    <link rel="icon" type="image/png" href="images/IMG_3689.jpeg">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/5024/5024445.png">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/5024/5024445.png">

    <title>SMOKE HUB PRO</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --bg-main: #0f172a;
            --card-surface: #1e293b;
            --accent-primary: #8b5cf6;
            --accent-secondary: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --text-p: #94a3b8;
        }

        body {
            margin: 0;
            font-family: 'SF Pro Display', -apple-system, system-ui, sans-serif;
            background-color: var(--bg-main);
            color: #f8fafc;
            /* –í—ñ–¥—Å—Ç—É–ø–∏ –¥–ª—è –±–µ–∑–ø–µ—á–Ω–∏—Ö –∑–æ–Ω iPhone (notch) */
            padding: calc(10px + env(safe-area-inset-top)) 16px calc(20px + env(safe-area-inset-bottom));
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
            box-sizing: border-box;
        }

        /* Dashboard Header */
        .dashboard-header { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-bottom: 20px;
        }

        .balance-card {
            background: linear-gradient(135deg, var(--card-surface), #334155);
            padding: 14px; 
            border-radius: 20px; 
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .balance-card span { font-size: 10px; color: var(--text-p); text-transform: uppercase; letter-spacing: 0.5px; }
        .balance-card div { font-size: 20px; font-weight: 700; margin-top: 4px; }

        /* Navigation Tabs - Sticky –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º Notch */
        .nav-tabs { 
            display: flex; 
            background: var(--card-surface); 
            padding: 4px; 
            border-radius: 14px; 
            margin-bottom: 20px; 
            gap: 4px; 
            position: sticky; 
            top: env(safe-area-inset-top); 
            z-index: 1000;
            box-shadow: 0 10px 15px -10px rgba(0,0,0,0.5);
        }

        .tab-btn { 
            flex: 1; 
            padding: 12px 4px; 
            border: none; 
            background: transparent; 
            color: var(--text-p); 
            font-weight: 600; 
            font-size: 11px; 
            border-radius: 10px; 
            white-space: nowrap; 
            transition: 0.2s;
        }

        .tab-btn.active { 
            background: var(--accent-primary); 
            color: white; 
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4); 
        }

        /* Forms */
        .main-form, .admin-panel { 
            background: var(--card-surface); 
            border-radius: 24px; 
            padding: 18px; 
            margin-bottom: 16px; 
            border: 1px solid rgba(255,255,255,0.03); 
        }

        .form-row { margin-bottom: 16px; }
        label { display: block; font-size: 10px; color: var(--accent-secondary); margin-bottom: 6px; font-weight: bold; text-transform: uppercase; }

        select, input {
            width: 100%; 
            height: 52px; 
            background: #0f172a; 
            border: 1px solid #334155;
            border-radius: 14px; 
            padding: 0 14px; 
            color: white; 
            font-size: 16px; 
            box-sizing: border-box; 
            outline: none;
            -webkit-appearance: none;
        }

        input::placeholder { color: #475569; }

        .price-tag { text-align: center; font-size: 38px; font-weight: 800; margin: 20px 0; color: #fff; }

        .btn-submit { 
            width: 100%; 
            height: 60px; 
            background: linear-gradient(135deg, var(--accent-primary), #7c3aed); 
            border: none; 
            border-radius: 18px; 
            color: white; 
            font-weight: 700; 
            font-size: 17px; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
        }

        .btn-submit:active { transform: scale(0.98); opacity: 0.9; }

        /* Lists */
        .list-item {
            background: var(--card-surface); 
            padding: 16px; 
            border-radius: 20px; 
            margin-bottom: 12px;
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-left: 5px solid var(--accent-secondary);
        }
        .item-main b { display: block; font-size: 15px; margin-bottom: 4px; }
        .item-main span { font-size: 12px; color: var(--text-p); }
        .qty-badge { background: #0f172a; padding: 2px 8px; border-radius: 8px; font-size: 11px; color: var(--accent-secondary); margin-left: 5px; }

        #location-box { 
            background: rgba(6, 182, 212, 0.1); 
            padding: 14px; 
            border-radius: 14px; 
            margin-bottom: 15px; 
            display: none; 
            font-size: 14px; 
            border: 1px dashed var(--accent-secondary); 
            color: #e2e8f0;
        }
    </style>
</head>
<body>

<div class="dashboard-header">
    <div class="balance-card"><span>PLN</span><div id="totalPLN">0</div></div>
    <div class="balance-card"><span>UAH</span><div id="totalUAH">0</div></div>
</div>

<div class="nav-tabs">
    <button class="tab-btn active" onclick="showTab('new')">–ö–ê–°–ê</button>
    <button class="tab-btn" onclick="showTab('debts')">–ë–û–†–ì–ò</button>
    <button class="tab-btn" onclick="showTab('history')">–ê–†–•–Ü–í</button>
    <button class="tab-btn" onclick="showTab('admin')">‚öôÔ∏è –°–ö–õ–ê–î</button>
</div>

<div id="tab-new" class="tab-content">
    <div class="main-form">
        <div class="form-row">
            <label>–ö–ê–¢–ê–õ–û–ì</label>
            <select id="catalog" onchange="updateFlavorList()"><option value="–∑–∞–ª–∏–≤–∫–∞">üß™ –ó–∞–ª–∏–≤–∫–∞ —Ä—ñ–¥–∏–Ω–∏</option><option value="–ø—Ä–æ–¥–∞–∂">üì¶ –ì–æ—Ç–æ–≤–∏–π —Ç–æ–≤–∞—Ä</option></select>
        </div>
        <div class="form-row">
            <label>–ü–û–®–£–ö –¢–ê –°–ú–ê–ö</label>
            <input type="text" id="flavorSearch" placeholder="üîç –ü–æ—à—É–∫ —Å–º–∞–∫—É..." oninput="updateFlavorList()">
            <select id="flavor" onchange="handleFlavor()" style="margin-top:8px;"></select>
        </div>
        <div id="location-box">üìç <b>–î–µ –ª–µ–∂–∏—Ç—å:</b> <span id="loc-text"></span></div>
        <div class="form-row" id="vol-box"><label>–û–ë'–Ñ–ú</label><select id="size" onchange="calc()"><option value="2">2 ml</option><option value="3">3 ml</option></select></div>
        <div class="form-row"><label>–ú–ï–¢–û–î –û–ü–õ–ê–¢–ò</label><select id="pay" onchange="calc()"><option value="–ì–æ—Ç—ñ–≤–∫–∞">–ì–æ—Ç—ñ–≤–∫–∞ PLN</option><option value="–ö–∞—Ä—Ç–∞">–ö–∞—Ä—Ç–∞ PLN</option><option value="–ú–æ–Ω–æ–±–∞–Ω–∫">Mono UAH</option></select></div>
        <div class="form-row"><label>–°–¢–ê–¢–£–°</label><select id="status" onchange="toggleDebt()"><option value="paid">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ</option><option value="debt">üö© –ë–æ—Ä–≥</option></select></div>
        <div id="debtor-row" class="form-row" style="display:none"><label>–•–¢–û –ë–ï–†–ï?</label><input type="text" id="debtorName" placeholder="–Ü–º'—è –±–æ—Ä–∂–Ω–∏–∫–∞"></div>
        <div class="form-row"><label>–í–õ–ê–°–ù–ê –¶–Ü–ù–ê</label><input type="number" id="manualPrice" oninput="calc()" placeholder="–í–≤–µ–¥—ñ—Ç—å —è–∫—â–æ —ñ–Ω—à–∞"></div>
        <div class="price-tag" id="total">0</div>
        <button class="btn-submit" onclick="saveOrder()">–ü–Ü–î–¢–í–ï–†–î–ò–¢–ò</button>
    </div>
</div>

<div id="tab-admin" class="tab-content" style="display:none">
    <div class="admin-panel">
        <input type="hidden" id="editId">
        <div class="form-row"><label>–ù–ê–ó–í–ê –°–ú–ê–ö–£</label><input type="text" id="newFlavorName" placeholder="–ù–∞–∑–≤–∞"></div>
        <div class="form-row"><label>–õ–û–ö–ê–¶–Ü–Ø</label><input type="text" id="newLoc" placeholder="–î–µ –ª–µ–∂–∏—Ç—å"></div>
        <div class="form-row"><label>–ö–Ü–õ–¨–ö–Ü–°–¢–¨ (–î–õ–Ø –¢–û–í–ê–†–£)</label><input type="number" id="newQty" value="10"></div>
        <button class="btn-submit" id="saveFlavorBtn" onclick="addFlavorToInventory()">–ó–ë–ï–†–ï–ì–¢–ò</button>
        <button class="btn-submit" id="cancelEditBtn" style="display:none; background:#475569; margin-top:8px;" onclick="cancelEdit()">–°–ö–ê–°–£–í–ê–¢–ò</button>
    </div>
    <div id="inventoryList"></div>
</div>

<div id="tab-debts" class="tab-content" style="display:none"><div id="debtList"></div></div>
<div id="tab-history" class="tab-content" style="display:none"><div id="logs"></div></div>

<script>
    // Manifest & Firebase Config (–∑–∞–ª–∏—à–∞—î–º–æ —è–∫ –±—É–ª–æ)
    const manifest = {
        "name": "Smoke Hub Pro",
        "short_name": "SmokeHub",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#0f172a",
        "theme_color": "#0f172a",
        "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/5024/5024445.png", "sizes": "512x512", "type": "image/png" }]
    };
    const stringManifest = JSON.stringify(manifest);
    const blob = new Blob([stringManifest], {type: 'application/json'});
    const manifestURL = URL.createObjectURL(blob);
    document.querySelector('head').innerHTML += `<link rel="manifest" href="${manifestURL}">`;

    const firebaseConfig = {
      apiKey: "AIzaSyAOW2GEW1McWRAzs4RLVOGHvcoAnRhgRC4",
      authDomain: "smokehub-7a072.firebaseapp.com",
      projectId: "smokehub-7a072",
      storageBucket: "smokehub-7a072.firebasestorage.app",
      messagingSenderId: "563107040578",
      appId: "1:563107040578:web:6379a7bc43bb7b58794cdb"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let inventory = [];
    const initialFlavors = {"ICE SHOT": "–ê–ø—Ç–µ—á–∫–∞ —Å–∏–Ω—è", "spermint": "—à–∞—Ñ–∞ —á–æ—Ä–Ω–∞ –∫—É—Ä—Ç–∫–∞", "double grape": "–∑–ª—ñ–≤–∞ –ª—ñ–∂–∫–æ –¥–∞–Ω—ñ", "apple mixed": "—à–∞—Ñ–∞ —á–æ—Ä–Ω–∞ –∫—É—Ä—Ç–∫–∞", "berry mint": "—Å–ø—Ä–∞–≤–∞ –¥–∞–Ω—ñ –ª—ñ–∂–∫–æ", "blackurant grape": "—à–∞—Ñ–∞ –∑–≤–µ—Ä—Ö—É –¥–∞–Ω—è", "blueberry curant": "—Å–ø—Ä–∞–≤–∞ –¥–∞–Ω—ñ –ª—ñ–∂–∫–æ", "watermelon melon": "—à–∞—Ñ–∞ –∑–≤–µ—Ä—Ö—É –¥–∞–Ω—ñ", "cranberry mors": "—à–∞—Ñ–∞ —á–æ—Ä–Ω–∞ –∫—É—Ä—Ç–∫–∞", "double raspberry": "—à–∞—Ñ–∞ —á–æ—Ä–Ω–∞ –∫—É—Ä—Ç–∫–∞", "Cola Lemon": "—à–∞—Ñ–∞ –∑–≤–µ—Ä—Ö—É –æ–ª–µ–≥", "RedBull blue raspberry": "–∑–ª—ñ–≤–∞ –¥–∞–Ω—ñ –ª—ñ–∂–∫–æ", "pineaple lemonade": "—à–∞—Ñ–∞ —á–æ—Ä–Ω–∞ –∫—É—Ä—Ç–∫–∞", "multifruit": "–≤ –ø–∞–∫–µ—Ç—ñ –≤ —à–∞—Ñ—ñ –¥–∞–Ω—ñ", "bali triple shot": "–≤ –ø–∞–∫–µ—Ç—ñ –≤ —à–∞—Ñ—ñ –¥–∞–Ω—ñ", "watermelon lychee": "—à–∞—Ñ–∞ —á–æ—Ä–Ω–∞ –∫—É—Ä—Ç–∫–∞"};

    async function checkInit() {
        const snap = await db.collection("inventory").limit(1).get();
        if(snap.empty) {
            for(let name in initialFlavors) {
                await db.collection("inventory").add({ name, loc: initialFlavors[name], qty: 10 });
            }
        }
    }

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + tabId).style.display = 'block';
        if(window.event) window.event.currentTarget.classList.add('active');
    }

    async function addFlavorToInventory() {
        const name = document.getElementById('newFlavorName').value;
        const loc = document.getElementById('newLoc').value;
        const qty = parseInt(document.getElementById('newQty').value) || 0;
        const id = document.getElementById('editId').value;
        if(!name) return;
        id ? await db.collection("inventory").doc(id).update({name, loc, qty}) : await db.collection("inventory").add({name, loc, qty});
        cancelEdit();
    }

    function editFlavor(id, name, loc, qty) {
        document.getElementById('editId').value = id;
        document.getElementById('newFlavorName').value = name;
        document.getElementById('newLoc').value = loc;
        document.getElementById('newQty').value = qty;
        document.getElementById('saveFlavorBtn').innerText = "–û–ù–û–í–ò–¢–ò";
        document.getElementById('cancelEditBtn').style.display = "block";
        showTab('admin');
    }

    function cancelEdit() {
        document.getElementById('editId').value = "";
        document.getElementById('newFlavorName').value = "";
        document.getElementById('newLoc').value = "";
        document.getElementById('newQty').value = 10;
        document.getElementById('saveFlavorBtn').innerText = "–ó–ë–ï–†–ï–ì–¢–ò";
        document.getElementById('cancelEditBtn').style.display = "none";
    }

    function updateFlavorList() {
        const cat = document.getElementById('catalog').value;
        const query = document.getElementById('flavorSearch').value.toLowerCase();
        const fs = document.getElementById('flavor');
        fs.innerHTML = '<option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å —Å–º–∞–∫</option>';
        let filtered = inventory.filter(f => f.name.toLowerCase().includes(query));
        
        if(cat === '–ø—Ä–æ–¥–∞–∂') {
            fs.innerHTML += `<option value="ICE SHOT">ICE SHOT üßä</option>`;
            filtered.forEach(f => {
                fs.innerHTML += `<option value="${f.name}">${f.name} (30ml) [${f.qty}—à—Ç]</option>`;
            });
            document.getElementById('vol-box').style.display = 'none';
        } else {
            filtered.forEach(f => {
                fs.innerHTML += `<option value="${f.name}">${f.name}</option>`;
            });
            document.getElementById('vol-box').style.display = 'block';
        }
        calc();
    }

    function handleFlavor() {
        const sel = document.getElementById('flavor').value;
        const item = inventory.find(i => i.name === sel);
        const box = document.getElementById('location-box');
        if(item) {
            box.style.display = 'block';
            document.getElementById('loc-text').innerText = item.loc || "–ù–µ –≤–∫–∞–∑–∞–Ω–æ";
        } else if(sel === "ICE SHOT") {
            box.style.display = 'block'; document.getElementById('loc-text').innerText = "–ê–ø—Ç–µ—á–∫–∞ —Å–∏–Ω—è";
        } else box.style.display = 'none';
        calc();
    }

    function calc() {
        const cat = document.getElementById('catalog').value, p = document.getElementById('pay').value, s = document.getElementById('size').value, f = document.getElementById('flavor').value, manual = document.getElementById('manualPrice').value;
        let cur = (p === "–ú–æ–Ω–æ–±–∞–Ω–∫") ? "–≥—Ä–Ω" : "–∑–ª", price = 0;
        if (manual > 0) price = manual;
        else if (cat === "–ø—Ä–æ–¥–∞–∂") price = (f === "ICE SHOT") ? (p === "–ú–æ–Ω–æ–±–∞–Ω–∫" ? 180 : 15) : (p === "–ú–æ–Ω–æ–±–∞–Ω–∫" ? 650 : 60);
        else price = (p === "–ú–æ–Ω–æ–±–∞–Ω–∫") ? (s === "2" ? 70 : 100) : (s === "2" ? 6 : 9);
        document.getElementById('total').innerText = `${price} ${cur}`;
    }

    function toggleDebt() { document.getElementById('debtor-row').style.display = (document.getElementById('status').value === 'debt') ? 'block' : 'none'; }

    async function saveOrder() {
        const fName = document.getElementById('flavor').value;
        const cat = document.getElementById('catalog').value;
        if(!fName) return alert("–û–±–µ—Ä—ñ—Ç—å —Ç–æ–≤–∞—Ä!");
        
        const item = inventory.find(i => i.name === fName);
        if(cat === '–ø—Ä–æ–¥–∞–∂' && item && item.id) {
            await db.collection("inventory").doc(item.id).update({ qty: firebase.firestore.FieldValue.increment(-1) });
        }

        const priceStr = document.getElementById('total').innerText;
        await db.collection("orders").add({
            catalog: cat, flavor: fName + (cat === '–ø—Ä–æ–¥–∞–∂' ? " (30ml)" : ""), 
            pay: document.getElementById('pay').value,
            priceVal: parseInt(priceStr), currency: priceStr.includes("–≥—Ä–Ω") ? "UAH" : "PLN",
            fullPrice: priceStr, status: document.getElementById('status').value, 
            debtor: document.getElementById('debtorName').value || "", date: new Date().getTime()
        });
        
        alert("–ó–∞–ø–∏—Å–∞–Ω–æ! ‚úÖ");
        document.getElementById('manualPrice').value = "";
        document.getElementById('flavorSearch').value = "";
    }

    function sync() {
        checkInit();
        db.collection("inventory").orderBy("name").onSnapshot(snap => {
            inventory = [];
            const list = document.getElementById('inventoryList');
            list.innerHTML = "";
            snap.forEach(doc => {
                const i = doc.data();
                inventory.push({id: doc.id, ...i});
                list.innerHTML += `<div class="list-item">
                    <div class="item-main"><b>${i.name} <span class="qty-badge">${i.qty} —à—Ç</span></b><span>üìç ${i.loc}</span></div>
                    <div style="display:flex; gap:10px;">
                        <button style="background:none; border:1px solid var(--accent-secondary); color:white; border-radius:8px; padding:6px;" onclick="editFlavor('${doc.id}', '${i.name}', '${i.loc}', ${i.qty})">‚úèÔ∏è</button>
                        <button style="background:none; border:none; color:var(--danger); font-size:18px;" onclick="if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Å–º–∞–∫?')) db.collection('inventory').doc('${doc.id}').delete()">üóëÔ∏è</button>
                    </div>
                </div>`;
            });
            updateFlavorList();
        });

        db.collection("orders").orderBy("date", "desc").onSnapshot(snap => {
            const logs = document.getElementById('logs'), debts = document.getElementById('debtList');
            let pln = 0, uah = 0;
            logs.innerHTML = ""; debts.innerHTML = "";
            snap.forEach(doc => {
                const item = doc.data(), id = doc.id;
                if(item.status === 'paid') {
                    if(item.currency === "PLN") pln += item.priceVal; else uah += item.priceVal;
                    logs.innerHTML += `<div class="list-item">
                        <div class="item-main"><b>${item.flavor}</b><span>${item.pay}</span></div>
                        <div style="text-align:right"><b>${item.fullPrice}</b><div style="margin-top:5px" onclick="if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Å?')) db.collection('orders').doc('${id}').delete()">üóëÔ∏è</div></div>
                    </div>`;
                } else {
                    debts.innerHTML += `<div class="list-item" style="border-left-color:var(--warning)">
                        <div class="item-main"><b>${item.debtor}</b><span>${item.flavor}</span></div>
                        <div style="text-align:right"><b>${item.fullPrice}</b><button style="display:block; margin-top:5px; background:var(--success); border:none; color:white; border-radius:6px; padding:4px 8px; font-size:10px;" onclick="db.collection('orders').doc('${id}').update({status:'paid'})">–û–ü–õ–ê–¢–ò–í</button></div>
                    </div>`;
                }
            });
            document.getElementById('totalPLN').innerText = pln + " Z≈Å";
            document.getElementById('totalUAH').innerText = uah + " ‚Ç¥";
        });
    }

    sync();
</script>
</body>
</html>
